cscope 15 /media/shiruiwei/ourera/pcdn/kcp -q 0000000451 0000045180
	@ikcp.c

12 
	~"ikı.h
"

14 
	~<¡ddef.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

17 
	~<¡d¬g.h
>

18 
	~<¡dio.h
>

25 cÚ¡ 
IUINT32
 
	gIKCP_RTO_NDL
 = 30;

26 cÚ¡ 
IUINT32
 
	gIKCP_RTO_MIN
 = 100;

27 cÚ¡ 
IUINT32
 
	gIKCP_RTO_DEF
 = 200;

28 cÚ¡ 
IUINT32
 
	gIKCP_RTO_MAX
 = 60000;

29 cÚ¡ 
IUINT32
 
	gIKCP_CMD_PUSH
 = 81;

30 cÚ¡ 
IUINT32
 
	gIKCP_CMD_ACK
 = 82;

31 cÚ¡ 
IUINT32
 
	gIKCP_CMD_WASK
 = 83;

32 cÚ¡ 
IUINT32
 
	gIKCP_CMD_WINS
 = 84;

33 cÚ¡ 
IUINT32
 
	gIKCP_ASK_SEND
 = 1;

34 cÚ¡ 
IUINT32
 
	gIKCP_ASK_TELL
 = 2;

35 cÚ¡ 
IUINT32
 
	gIKCP_WND_SND
 = 32;

36 cÚ¡ 
IUINT32
 
	gIKCP_WND_RCV
 = 128;

37 cÚ¡ 
IUINT32
 
	gIKCP_MTU_DEF
 = 1400;

38 cÚ¡ 
IUINT32
 
	gIKCP_ACK_FAST
 = 3;

39 cÚ¡ 
IUINT32
 
	gIKCP_INTERVAL
 = 100;

40 cÚ¡ 
IUINT32
 
	gIKCP_OVERHEAD
 = 24;

41 cÚ¡ 
IUINT32
 
	gIKCP_DEADLINK
 = 20;

42 cÚ¡ 
IUINT32
 
	gIKCP_THRESH_INIT
 = 2;

43 cÚ¡ 
IUINT32
 
	gIKCP_THRESH_MIN
 = 2;

44 cÚ¡ 
IUINT32
 
	gIKCP_PROBE_INIT
 = 7000;

45 cÚ¡ 
IUINT32
 
	gIKCP_PROBE_LIMIT
 = 120000;

46 cÚ¡ 
IUINT32
 
	gIKCP_FASTACK_LIMIT
 = 5;

54 
šlše
 *
	$ikı_’code8u
(*
p
, 
c
)

56 *(*)
p
++ = 
c
;

57  
p
;

58 
	}
}

61 
šlše
 cÚ¡ *
	$ikı_decode8u
(cÚ¡ *
p
, *
c
)

63 *
c
 = *(*)
p
++;

64  
p
;

65 
	}
}

68 
šlše
 *
	$ikı_’code16u
(*
p
, 
w
)

70 #ià
IWORDS_BIG_ENDIAN
 || 
IWORDS_MUST_ALIGN


71 *(*)(
p
 + 0èğ(
w
 & 255);

72 *(*)(
p
 + 1èğ(
w
 >> 8);

74 
	`memıy
(
p
, &
w
, 2);

76 
p
 += 2;

77  
p
;

78 
	}
}

81 
šlše
 cÚ¡ *
	$ikı_decode16u
(cÚ¡ *
p
, *
w
)

83 #ià
IWORDS_BIG_ENDIAN
 || 
IWORDS_MUST_ALIGN


84 *
w
 = *(cÚ¡ *)(
p
 + 1);

85 *
w
 = *(cÚ¡ *)(
p
 + 0) + (*w << 8);

87 
	`memıy
(
w
, 
p
, 2);

89 
p
 += 2;

90  
p
;

91 
	}
}

94 
šlše
 *
	$ikı_’code32u
(*
p
, 
IUINT32
 
l
)

96 #ià
IWORDS_BIG_ENDIAN
 || 
IWORDS_MUST_ALIGN


97 *(*)(
p
 + 0èğ()((
l
 >> 0) & 0xff);

98 *(*)(
p
 + 1èğ()((
l
 >> 8) & 0xff);

99 *(*)(
p
 + 2èğ()((
l
 >> 16) & 0xff);

100 *(*)(
p
 + 3èğ()((
l
 >> 24) & 0xff);

102 
	`memıy
(
p
, &
l
, 4);

104 
p
 += 4;

105  
p
;

106 
	}
}

109 
šlše
 cÚ¡ *
	$ikı_decode32u
(cÚ¡ *
p
, 
IUINT32
 *
l
)

111 #ià
IWORDS_BIG_ENDIAN
 || 
IWORDS_MUST_ALIGN


112 *
l
 = *(cÚ¡ *)(
p
 + 3);

113 *
l
 = *(cÚ¡ *)(
p
 + 2) + (*l << 8);

114 *
l
 = *(cÚ¡ *)(
p
 + 1) + (*l << 8);

115 *
l
 = *(cÚ¡ *)(
p
 + 0) + (*l << 8);

117 
	`memıy
(
l
, 
p
, 4);

119 
p
 += 4;

120  
p
;

121 
	}
}

123 
šlše
 
IUINT32
 
	$_imš_
(
IUINT32
 
a
, IUINT32 
b
) {

124  
a
 <ğ
b
 ?‡ : b;

125 
	}
}

127 
šlše
 
IUINT32
 
	$_imax_
(
IUINT32
 
a
, IUINT32 
b
) {

128  
a
 >ğ
b
 ?‡ : b;

129 
	}
}

131 
šlše
 
IUINT32
 
	$_ibound_
(
IUINT32
 
low”
, IUINT32 
middË
, IUINT32 
uµ”
)

133  
	`_imš_
(
	`_imax_
(
low”
, 
middË
), 
uµ”
);

134 
	}
}

136 
šlše
 
	$_™imediff
(
IUINT32
 
Ï‹r
, IUINT32 
—¾›r
)

138  ((
IINT32
)(
Ï‹r
 - 
—¾›r
));

139 
	}
}

144 
IKCPSEG
 
	tIKCPSEG
;

146 * (*
	gikı_m®loc_hook
)(
	gsize_t
èğ
NULL
;

147 (*
ikı_ä“_hook
)(*èğ
NULL
;

150 * 
	$ikı_m®loc
(
size_t
 
size
) {

151 ià(
ikı_m®loc_hook
)

152  
	`ikı_m®loc_hook
(
size
);

153  
	`m®loc
(
size
);

154 
	}
}

157 
	$ikı_ä“
(*
±r
) {

158 ià(
ikı_ä“_hook
) {

159 
	`ikı_ä“_hook
(
±r
);

161 
	`ä“
(
±r
);

163 
	}
}

166 
	$ikı_®loÿtÜ
(* (*
Ãw_m®loc
)(
size_t
), (*
Ãw_ä“
)(*))

168 
ikı_m®loc_hook
 = 
Ãw_m®loc
;

169 
ikı_ä“_hook
 = 
Ãw_ä“
;

170 
	}
}

173 
IKCPSEG
* 
	$ikı_£gm’t_Ãw
(
ikıcb
 *
kı
, 
size
)

175  (
IKCPSEG
*)
	`ikı_m®loc
((IKCPSEGè+ 
size
);

176 
	}
}

179 
	$ikı_£gm’t_d–‘e
(
ikıcb
 *
kı
, 
IKCPSEG
 *
£g
)

181 
	`ikı_ä“
(
£g
);

182 
	}
}

185 
	$ikı_log
(
ikıcb
 *
kı
, 
mask
, cÚ¡ *
fmt
, ...)

187 
bufãr
[1024];

188 
va_li¡
 
¬g±r
;

189 ià((
mask
 & 
kı
->
logmask
è=ğ0 || kı->
wr™–og
 == 0) ;

190 
	`va_¡¬t
(
¬g±r
, 
fmt
);

191 
	`v¥rštf
(
bufãr
, 
fmt
, 
¬g±r
);

192 
	`va_’d
(
¬g±r
);

193 
kı
->
	`wr™–og
(
bufãr
, kı, kı->
u£r
);

194 
	}
}

197 
	$ikı_ÿÆog
(cÚ¡ 
ikıcb
 *
kı
, 
mask
)

199 ià((
mask
 & 
kı
->
logmask
è=ğ0 || kı->
wr™–og
 =ğ
NULL
)  0;

201 
	}
}

204 
	$ikı_ouut
(
ikıcb
 *
kı
, cÚ¡ *
d©a
, 
size
)

206 
	`as£¹
(
kı
);

207 
	`as£¹
(
kı
->
ouut
);

208 ià(
	`ikı_ÿÆog
(
kı
, 
IKCP_LOG_OUTPUT
)) {

209 
	`ikı_log
(
kı
, 
IKCP_LOG_OUTPUT
, "[RO] %ld by‹s", ()
size
);

211 ià(
size
 == 0)  0;

212  
kı
->
	`ouut
((cÚ¡ *)
d©a
, 
size
, kı, kı->
u£r
);

213 
	}
}

216 
	$ikı_q´št
(cÚ¡ *
Çme
, cÚ¡ 
IQUEUEHEAD
 *
h—d
)

219 cÚ¡ 
IQUEUEHEAD
 *
p
;

220 
	`´štf
("<%s>: [", 
Çme
);

221 
p
 = 
h—d
->
Ãxt
;… != head;… =…->next) {

222 cÚ¡ 
IKCPSEG
 *
£g
 = 
	`iqueue_’Œy
(
p
, cÚ¡ IKCPSEG, 
node
);

223 
	`´štf
("(%lu %d)", ()
£g
->
¢
, ()(£g->
ts
 % 10000));

224 ià(
p
->
Ãxt
 !ğ
h—d
è
	`´štf
(",");

226 
	`´štf
("]\n");

228 
	}
}

234 
ikıcb
* 
	$ikı_ü—‹
(
IUINT32
 
cÚv
, *
u£r
)

236 
ikıcb
 *
kı
 = (ikıcb*)
	`ikı_m®loc
((
IKCPCB
));

237 ià(
kı
 =ğ
NULL
)  NULL;

238 
kı
->
cÚv
 = conv;

239 
kı
->
u£r
 = user;

240 
kı
->
¢d_uÇ
 = 0;

241 
kı
->
¢d_nxt
 = 0;

242 
kı
->
rcv_nxt
 = 0;

243 
kı
->
ts_»ûÁ
 = 0;

244 
kı
->
ts_Ï¡ack
 = 0;

245 
kı
->
ts_´obe
 = 0;

246 
kı
->
´obe_wa™
 = 0;

247 
kı
->
¢d_wnd
 = 
IKCP_WND_SND
;

248 
kı
->
rcv_wnd
 = 
IKCP_WND_RCV
;

249 
kı
->
rmt_wnd
 = 
IKCP_WND_RCV
;

250 
kı
->
cwnd
 = 0;

251 
kı
->
šü
 = 0;

252 
kı
->
´obe
 = 0;

253 
kı
->
mtu
 = 
IKCP_MTU_DEF
;

254 
kı
->
mss
 = kı->
mtu
 - 
IKCP_OVERHEAD
;

255 
kı
->
¡»am
 = 0;

257 
kı
->
bufãr
 = (*)
	`ikı_m®loc
((kı->
mtu
 + 
IKCP_OVERHEAD
) * 3);

258 ià(
kı
->
bufãr
 =ğ
NULL
) {

259 
	`ikı_ä“
(
kı
);

260  
NULL
;

263 
	`iqueue_š™
(&
kı
->
¢d_queue
);

264 
	`iqueue_š™
(&
kı
->
rcv_queue
);

265 
	`iqueue_š™
(&
kı
->
¢d_buf
);

266 
	`iqueue_š™
(&
kı
->
rcv_buf
);

267 
kı
->
Äcv_buf
 = 0;

268 
kı
->
n¢d_buf
 = 0;

269 
kı
->
Äcv_que
 = 0;

270 
kı
->
n¢d_que
 = 0;

271 
kı
->
¡©e
 = 0;

272 
kı
->
ackli¡
 = 
NULL
;

273 
kı
->
ackblock
 = 0;

274 
kı
->
ackcouÁ
 = 0;

275 
kı
->
rx_¤‰
 = 0;

276 
kı
->
rx_¹tv®
 = 0;

277 
kı
->
rx_¹o
 = 
IKCP_RTO_DEF
;

278 
kı
->
rx_mš¹o
 = 
IKCP_RTO_MIN
;

279 
kı
->
cu¼’t
 = 0;

280 
kı
->
š‹rv®
 = 
IKCP_INTERVAL
;

281 
kı
->
ts_æush
 = 
IKCP_INTERVAL
;

282 
kı
->
nod–ay
 = 0;

283 
kı
->
upd©ed
 = 0;

284 
kı
->
logmask
 = 0;

285 
kı
->
s¡h»sh
 = 
IKCP_THRESH_INIT
;

286 
kı
->
ç¡»£nd
 = 0;

287 
kı
->
ç¡lim™
 = 
IKCP_FASTACK_LIMIT
;

288 
kı
->
nocwnd
 = 0;

289 
kı
->
xm™
 = 0;

290 
kı
->
d—d_lšk
 = 
IKCP_DEADLINK
;

291 
kı
->
ouut
 = 
NULL
;

292 
kı
->
wr™–og
 = 
NULL
;

294  
kı
;

295 
	}
}

301 
	$ikı_»Ëa£
(
ikıcb
 *
kı
)

303 
	`as£¹
(
kı
);

304 ià(
kı
) {

305 
IKCPSEG
 *
£g
;

306 !
	`iqueue_is_em±y
(&
kı
->
¢d_buf
)) {

307 
£g
 = 
	`iqueue_’Œy
(
kı
->
¢d_buf
.
Ãxt
, 
IKCPSEG
, 
node
);

308 
	`iqueue_d–
(&
£g
->
node
);

309 
	`ikı_£gm’t_d–‘e
(
kı
, 
£g
);

311 !
	`iqueue_is_em±y
(&
kı
->
rcv_buf
)) {

312 
£g
 = 
	`iqueue_’Œy
(
kı
->
rcv_buf
.
Ãxt
, 
IKCPSEG
, 
node
);

313 
	`iqueue_d–
(&
£g
->
node
);

314 
	`ikı_£gm’t_d–‘e
(
kı
, 
£g
);

316 !
	`iqueue_is_em±y
(&
kı
->
¢d_queue
)) {

317 
£g
 = 
	`iqueue_’Œy
(
kı
->
¢d_queue
.
Ãxt
, 
IKCPSEG
, 
node
);

318 
	`iqueue_d–
(&
£g
->
node
);

319 
	`ikı_£gm’t_d–‘e
(
kı
, 
£g
);

321 !
	`iqueue_is_em±y
(&
kı
->
rcv_queue
)) {

322 
£g
 = 
	`iqueue_’Œy
(
kı
->
rcv_queue
.
Ãxt
, 
IKCPSEG
, 
node
);

323 
	`iqueue_d–
(&
£g
->
node
);

324 
	`ikı_£gm’t_d–‘e
(
kı
, 
£g
);

326 ià(
kı
->
bufãr
) {

327 
	`ikı_ä“
(
kı
->
bufãr
);

329 ià(
kı
->
ackli¡
) {

330 
	`ikı_ä“
(
kı
->
ackli¡
);

333 
kı
->
Äcv_buf
 = 0;

334 
kı
->
n¢d_buf
 = 0;

335 
kı
->
Äcv_que
 = 0;

336 
kı
->
n¢d_que
 = 0;

337 
kı
->
ackcouÁ
 = 0;

338 
kı
->
bufãr
 = 
NULL
;

339 
kı
->
ackli¡
 = 
NULL
;

340 
	`ikı_ä“
(
kı
);

342 
	}
}

348 
	$ikı_£touut
(
ikıcb
 *
kı
, (*
ouut
)(cÚ¡ *
buf
, 
Ën
,

349 
ikıcb
 *
kı
, *
u£r
))

351 
kı
->
ouut
 = output;

352 
	}
}

358 
	$ikı_»cv
(
ikıcb
 *
kı
, *
bufãr
, 
Ën
)

360 
IQUEUEHEAD
 *
p
;

361 
i¥“k
 = (
Ën
 < 0)? 1 : 0;

362 
³eksize
;

363 
»cov”
 = 0;

364 
IKCPSEG
 *
£g
;

365 
	`as£¹
(
kı
);

367 ià(
	`iqueue_is_em±y
(&
kı
->
rcv_queue
))

370 ià(
Ën
 < 0)†en = -len;

372 
³eksize
 = 
	`ikı_³eksize
(
kı
);

374 ià(
³eksize
 < 0)

377 ià(
³eksize
 > 
Ën
)

380 ià(
kı
->
Äcv_que
 >ğkı->
rcv_wnd
)

381 
»cov”
 = 1;

384 
Ën
 = 0, 
p
 = 
kı
->
rcv_queue
.
Ãxt
;… != &kcp->rcv_queue; ) {

385 
äagm’t
;

386 
£g
 = 
	`iqueue_’Œy
(
p
, 
IKCPSEG
, 
node
);

387 
p
 =…->
Ãxt
;

389 ià(
bufãr
) {

390 
	`memıy
(
bufãr
, 
£g
->
d©a
, seg->
Ën
);

391 
bufãr
 +ğ
£g
->
Ën
;

394 
Ën
 +ğ
£g
->len;

395 
äagm’t
 = 
£g
->
äg
;

397 ià(
	`ikı_ÿÆog
(
kı
, 
IKCP_LOG_RECV
)) {

398 
	`ikı_log
(
kı
, 
IKCP_LOG_RECV
, "»cv sn=%lu", ()
£g
->
¢
);

401 ià(
i¥“k
 == 0) {

402 
	`iqueue_d–
(&
£g
->
node
);

403 
	`ikı_£gm’t_d–‘e
(
kı
, 
£g
);

404 
kı
->
Äcv_que
--;

407 ià(
äagm’t
 == 0)

411 
	`as£¹
(
Ën
 =ğ
³eksize
);

414 ! 
	`iqueue_is_em±y
(&
kı
->
rcv_buf
)) {

415 
£g
 = 
	`iqueue_’Œy
(
kı
->
rcv_buf
.
Ãxt
, 
IKCPSEG
, 
node
);

416 ià(
£g
->
¢
 =ğ
kı
->
rcv_nxt
 && kı->
Äcv_que
 < kı->
rcv_wnd
) {

417 
	`iqueue_d–
(&
£g
->
node
);

418 
kı
->
Äcv_buf
--;

419 
	`iqueue_add_
(&
£g
->
node
, &
kı
->
rcv_queue
);

420 
kı
->
Äcv_que
++;

421 
kı
->
rcv_nxt
++;

428 ià(
kı
->
Äcv_que
 < kı->
rcv_wnd
 && 
»cov”
) {

431 
kı
->
´obe
 |ğ
IKCP_ASK_TELL
;

434  
Ën
;

435 
	}
}

441 
	$ikı_³eksize
(cÚ¡ 
ikıcb
 *
kı
)

443 
IQUEUEHEAD
 *
p
;

444 
IKCPSEG
 *
£g
;

445 
Ëngth
 = 0;

447 
	`as£¹
(
kı
);

449 ià(
	`iqueue_is_em±y
(&
kı
->
rcv_queue
))  -1;

451 
£g
 = 
	`iqueue_’Œy
(
kı
->
rcv_queue
.
Ãxt
, 
IKCPSEG
, 
node
);

452 ià(
£g
->
äg
 =ğ0è seg->
Ën
;

454 ià(
kı
->
Äcv_que
 < 
£g
->
äg
 + 1)  -1;

456 
p
 = 
kı
->
rcv_queue
.
Ãxt
;… != &kcp->rcv_queue;… =…->next) {

457 
£g
 = 
	`iqueue_’Œy
(
p
, 
IKCPSEG
, 
node
);

458 
Ëngth
 +ğ
£g
->
Ën
;

459 ià(
£g
->
äg
 == 0) ;

462  
Ëngth
;

463 
	}
}

469 
	$ikı_£nd
(
ikıcb
 *
kı
, cÚ¡ *
bufãr
, 
Ën
)

471 
IKCPSEG
 *
£g
;

472 
couÁ
, 
i
;

474 
	`as£¹
(
kı
->
mss
 > 0);

475 ià(
Ën
 < 0)  -1;

478 ià(
kı
->
¡»am
 != 0) {

479 ià(!
	`iqueue_is_em±y
(&
kı
->
¢d_queue
)) {

480 
IKCPSEG
 *
Şd
 = 
	`iqueue_’Œy
(
kı
->
¢d_queue
.
´ev
, IKCPSEG, 
node
);

481 ià(
Şd
->
Ën
 < 
kı
->
mss
) {

482 
ÿ·c™y
 = 
kı
->
mss
 - 
Şd
->
Ën
;

483 
ex‹nd
 = (
Ën
 < 
ÿ·c™y
)?†en : capacity;

484 
£g
 = 
	`ikı_£gm’t_Ãw
(
kı
, 
Şd
->
Ën
 + 
ex‹nd
);

485 
	`as£¹
(
£g
);

486 ià(
£g
 =ğ
NULL
) {

489 
	`iqueue_add_
(&
£g
->
node
, &
kı
->
¢d_queue
);

490 
	`memıy
(
£g
->
d©a
, 
Şd
->d©a, old->
Ën
);

491 ià(
bufãr
) {

492 
	`memıy
(
£g
->
d©a
 + 
Şd
->
Ën
, 
bufãr
, 
ex‹nd
);

493 
bufãr
 +ğ
ex‹nd
;

495 
£g
->
Ën
 = 
Şd
->ËÀ+ 
ex‹nd
;

496 
£g
->
äg
 = 0;

497 
Ën
 -ğ
ex‹nd
;

498 
	`iqueue_d–_š™
(&
Şd
->
node
);

499 
	`ikı_£gm’t_d–‘e
(
kı
, 
Şd
);

502 ià(
Ën
 <= 0) {

507 ià(
Ën
 <ğ()
kı
->
mss
è
couÁ
 = 1;

508 
couÁ
 = (
Ën
 + 
kı
->
mss
 - 1) / kcp->mss;

510 ià(
couÁ
 >ğ()
IKCP_WND_RCV
)  -2;

512 ià(
couÁ
 == 0) count = 1;

515 
i
 = 0; i < 
couÁ
; i++) {

516 
size
 = 
Ën
 > ()
kı
->
mss
 ? ()kcp->mss :†en;

517 
£g
 = 
	`ikı_£gm’t_Ãw
(
kı
, 
size
);

518 
	`as£¹
(
£g
);

519 ià(
£g
 =ğ
NULL
) {

522 ià(
bufãr
 && 
Ën
 > 0) {

523 
	`memıy
(
£g
->
d©a
, 
bufãr
, 
size
);

525 
£g
->
Ën
 = 
size
;

526 
£g
->
äg
 = (
kı
->
¡»am
 =ğ0)? (
couÁ
 - 
i
 - 1) : 0;

527 
	`iqueue_š™
(&
£g
->
node
);

528 
	`iqueue_add_
(&
£g
->
node
, &
kı
->
¢d_queue
);

529 
kı
->
n¢d_que
++;

530 ià(
bufãr
) {

531 
bufãr
 +ğ
size
;

533 
Ën
 -ğ
size
;

537 
	}
}

543 
	$ikı_upd©e_ack
(
ikıcb
 *
kı
, 
IINT32
 
¹t
)

545 
IINT32
 
¹o
 = 0;

546 ià(
kı
->
rx_¤‰
 == 0) {

547 
kı
->
rx_¤‰
 = 
¹t
;

548 
kı
->
rx_¹tv®
 = 
¹t
 / 2;

550 
d–
 = 
¹t
 - 
kı
->
rx_¤‰
;

551 ià(
d–
 < 0) delta = -delta;

552 
kı
->
rx_¹tv®
 = (3 * kı->rx_¹tv® + 
d–
) / 4;

553 
kı
->
rx_¤‰
 = (7 * kı->rx_¤‰ + 
¹t
) / 8;

554 ià(
kı
->
rx_¤‰
 < 1) kcp->rx_srtt = 1;

556 
¹o
 = 
kı
->
rx_¤‰
 + 
	`_imax_
(kı->
š‹rv®
, 4 * kı->
rx_¹tv®
);

557 
kı
->
rx_¹o
 = 
	`_ibound_
(kı->
rx_mš¹o
, 
¹o
, 
IKCP_RTO_MAX
);

558 
	}
}

560 
	$ikı_shršk_buf
(
ikıcb
 *
kı
)

562 
IQUEUEHEAD
 *
p
 = 
kı
->
¢d_buf
.
Ãxt
;

563 ià(
p
 !ğ&
kı
->
¢d_buf
) {

564 
IKCPSEG
 *
£g
 = 
	`iqueue_’Œy
(
p
, IKCPSEG, 
node
);

565 
kı
->
¢d_uÇ
 = 
£g
->
¢
;

567 
kı
->
¢d_uÇ
 = kı->
¢d_nxt
;

569 
	}
}

571 
	$ikı_·r£_ack
(
ikıcb
 *
kı
, 
IUINT32
 
¢
)

573 
IQUEUEHEAD
 *
p
, *
Ãxt
;

575 ià(
	`_™imediff
(
¢
, 
kı
->
¢d_uÇ
è< 0 || _™imediff(¢, kı->
¢d_nxt
) >= 0)

578 
p
 = 
kı
->
¢d_buf
.
Ãxt
;… != &kcp->snd_buf;… =‚ext) {

579 
IKCPSEG
 *
£g
 = 
	`iqueue_’Œy
(
p
, IKCPSEG, 
node
);

580 
Ãxt
 = 
p
->next;

581 ià(
¢
 =ğ
£g
->sn) {

582 
	`iqueue_d–
(
p
);

583 
	`ikı_£gm’t_d–‘e
(
kı
, 
£g
);

584 
kı
->
n¢d_buf
--;

587 ià(
	`_™imediff
(
¢
, 
£g
->sn) < 0) {

591 
	}
}

593 
	$ikı_·r£_uÇ
(
ikıcb
 *
kı
, 
IUINT32
 
uÇ
)

595 
IQUEUEHEAD
 *
p
, *
Ãxt
;

596 
p
 = 
kı
->
¢d_buf
.
Ãxt
;… != &kcp->snd_buf;… =‚ext) {

597 
IKCPSEG
 *
£g
 = 
	`iqueue_’Œy
(
p
, IKCPSEG, 
node
);

598 
Ãxt
 = 
p
->next;

599 ià(
	`_™imediff
(
uÇ
, 
£g
->
¢
) > 0) {

600 
	`iqueue_d–
(
p
);

601 
	`ikı_£gm’t_d–‘e
(
kı
, 
£g
);

602 
kı
->
n¢d_buf
--;

607 
	}
}

609 
	$ikı_·r£_ç¡ack
(
ikıcb
 *
kı
, 
IUINT32
 
¢
, IUINT32 
ts
)

611 
IQUEUEHEAD
 *
p
, *
Ãxt
;

613 ià(
	`_™imediff
(
¢
, 
kı
->
¢d_uÇ
è< 0 || _™imediff(¢, kı->
¢d_nxt
) >= 0)

616 
p
 = 
kı
->
¢d_buf
.
Ãxt
;… != &kcp->snd_buf;… =‚ext) {

617 
IKCPSEG
 *
£g
 = 
	`iqueue_’Œy
(
p
, IKCPSEG, 
node
);

618 
Ãxt
 = 
p
->next;

619 ià(
	`_™imediff
(
¢
, 
£g
->sn) < 0) {

622 ià(
¢
 !ğ
£g
->sn) {

623 #iâdeà
IKCP_FASTACK_CONSERVE


624 
£g
->
ç¡ack
++;

626 ià(
	`_™imediff
(
ts
, 
£g
->ts) >= 0)

627 
£g
->
ç¡ack
++;

631 
	}
}

637 
	$ikı_ack_push
(
ikıcb
 *
kı
, 
IUINT32
 
¢
, IUINT32 
ts
)

639 
IUINT32
 
Ãwsize
 = 
kı
->
ackcouÁ
 + 1;

640 
IUINT32
 *
±r
;

642 ià(
Ãwsize
 > 
kı
->
ackblock
) {

643 
IUINT32
 *
ackli¡
;

644 
IUINT32
 
Ãwblock
;

646 
Ãwblock
 = 8;‚ewblock < 
Ãwsize
;‚ewblock <<= 1);

647 
ackli¡
 = (
IUINT32
*)
	`ikı_m®loc
(
Ãwblock
 * (IUINT32) * 2);

649 ià(
ackli¡
 =ğ
NULL
) {

650 
	`as£¹
(
ackli¡
 !ğ
NULL
);

651 
	`abÜt
();

654 ià(
kı
->
ackli¡
 !ğ
NULL
) {

655 
IUINT32
 
x
;

656 
x
 = 0; x < 
kı
->
ackcouÁ
; x++) {

657 
ackli¡
[
x
 * 2 + 0] = 
kı
->acklist[x * 2 + 0];

658 
ackli¡
[
x
 * 2 + 1] = 
kı
->acklist[x * 2 + 1];

660 
	`ikı_ä“
(
kı
->
ackli¡
);

663 
kı
->
ackli¡
 =‡cklist;

664 
kı
->
ackblock
 = 
Ãwblock
;

667 
±r
 = &
kı
->
ackli¡
[kı->
ackcouÁ
 * 2];

668 
±r
[0] = 
¢
;

669 
±r
[1] = 
ts
;

670 
kı
->
ackcouÁ
++;

671 
	}
}

673 
	$ikı_ack_g‘
(cÚ¡ 
ikıcb
 *
kı
, 
p
, 
IUINT32
 *
¢
, IUINT32 *
ts
)

675 ià(
¢
è¢[0] = 
kı
->
ackli¡
[
p
 * 2 + 0];

676 ià(
ts
èts[0] = 
kı
->
ackli¡
[
p
 * 2 + 1];

677 
	}
}

683 
	$ikı_·r£_d©a
(
ikıcb
 *
kı
, 
IKCPSEG
 *
Ãw£g
)

685 
IQUEUEHEAD
 *
p
, *
´ev
;

686 
IUINT32
 
¢
 = 
Ãw£g
->sn;

687 
»³©
 = 0;

689 ià(
	`_™imediff
(
¢
, 
kı
->
rcv_nxt
 + kı->
rcv_wnd
) >= 0 ||

690 
	`_™imediff
(
¢
, 
kı
->
rcv_nxt
) < 0) {

691 
	`ikı_£gm’t_d–‘e
(
kı
, 
Ãw£g
);

695 
p
 = 
kı
->
rcv_buf
.
´ev
;… != &kcp->rcv_buf;… =…rev) {

696 
IKCPSEG
 *
£g
 = 
	`iqueue_’Œy
(
p
, IKCPSEG, 
node
);

697 
´ev
 = 
p
->prev;

698 ià(
£g
->
¢
 == sn) {

699 
»³©
 = 1;

702 ià(
	`_™imediff
(
¢
, 
£g
->sn) > 0) {

707 ià(
»³©
 == 0) {

708 
	`iqueue_š™
(&
Ãw£g
->
node
);

709 
	`iqueue_add
(&
Ãw£g
->
node
, 
p
);

710 
kı
->
Äcv_buf
++;

712 
	`ikı_£gm’t_d–‘e
(
kı
, 
Ãw£g
);

716 
	`ikı_q´št
("rcvbuf", &
kı
->
rcv_buf
);

717 
	`´štf
("rcv_nxt=%lu\n", 
kı
->
rcv_nxt
);

721 ! 
	`iqueue_is_em±y
(&
kı
->
rcv_buf
)) {

722 
IKCPSEG
 *
£g
 = 
	`iqueue_’Œy
(
kı
->
rcv_buf
.
Ãxt
, IKCPSEG, 
node
);

723 ià(
£g
->
¢
 =ğ
kı
->
rcv_nxt
 && kı->
Äcv_que
 < kı->
rcv_wnd
) {

724 
	`iqueue_d–
(&
£g
->
node
);

725 
kı
->
Äcv_buf
--;

726 
	`iqueue_add_
(&
£g
->
node
, &
kı
->
rcv_queue
);

727 
kı
->
Äcv_que
++;

728 
kı
->
rcv_nxt
++;

735 
	`ikı_q´št
("queue", &
kı
->
rcv_queue
);

736 
	`´štf
("rcv_nxt=%lu\n", 
kı
->
rcv_nxt
);

743 
	}
}

749 
	$ikı_šput
(
ikıcb
 *
kı
, cÚ¡ *
d©a
, 
size
)

751 
IUINT32
 
´ev_uÇ
 = 
kı
->
¢d_uÇ
;

752 
IUINT32
 
maxack
 = 0, 
Ï‹¡_ts
 = 0;

753 
æag
 = 0;

755 ià(
	`ikı_ÿÆog
(
kı
, 
IKCP_LOG_INPUT
)) {

756 
	`ikı_log
(
kı
, 
IKCP_LOG_INPUT
, "[RI] %d by‹s", ()
size
);

759 ià(
d©a
 =ğ
NULL
 || ()
size
 < ()
IKCP_OVERHEAD
)  -1;

762 
IUINT32
 
ts
, 
¢
, 
Ën
, 
uÇ
, 
cÚv
;

763 
IUINT16
 
wnd
;

764 
IUINT8
 
cmd
, 
äg
;

765 
IKCPSEG
 *
£g
;

767 ià(
size
 < ()
IKCP_OVERHEAD
) ;

769 
d©a
 = 
	`ikı_decode32u
(d©a, &
cÚv
);

770 ià(
cÚv
 !ğ
kı
->conv)  -1;

772 
d©a
 = 
	`ikı_decode8u
(d©a, &
cmd
);

773 
d©a
 = 
	`ikı_decode8u
(d©a, &
äg
);

774 
d©a
 = 
	`ikı_decode16u
(d©a, &
wnd
);

775 
d©a
 = 
	`ikı_decode32u
(d©a, &
ts
);

776 
d©a
 = 
	`ikı_decode32u
(d©a, &
¢
);

777 
d©a
 = 
	`ikı_decode32u
(d©a, &
uÇ
);

778 
d©a
 = 
	`ikı_decode32u
(d©a, &
Ën
);

780 
size
 -ğ
IKCP_OVERHEAD
;

782 ià(()
size
 < ()
Ën
 || ()len < 0)  -2;

784 ià(
cmd
 !ğ
IKCP_CMD_PUSH
 && cmd !ğ
IKCP_CMD_ACK
 &&

785 
cmd
 !ğ
IKCP_CMD_WASK
 && cmd !ğ
IKCP_CMD_WINS
)

788 
kı
->
rmt_wnd
 = 
wnd
;

789 
	`ikı_·r£_uÇ
(
kı
, 
uÇ
);

790 
	`ikı_shršk_buf
(
kı
);

792 ià(
cmd
 =ğ
IKCP_CMD_ACK
) {

793 ià(
	`_™imediff
(
kı
->
cu¼’t
, 
ts
) >= 0) {

794 
	`ikı_upd©e_ack
(
kı
, 
	`_™imediff
(kı->
cu¼’t
, 
ts
));

796 
	`ikı_·r£_ack
(
kı
, 
¢
);

797 
	`ikı_shršk_buf
(
kı
);

798 ià(
æag
 == 0) {

799 
æag
 = 1;

800 
maxack
 = 
¢
;

801 
Ï‹¡_ts
 = 
ts
;

803 ià(
	`_™imediff
(
¢
, 
maxack
) > 0) {

804 #iâdeà
IKCP_FASTACK_CONSERVE


805 
maxack
 = 
¢
;

806 
Ï‹¡_ts
 = 
ts
;

808 ià(
	`_™imediff
(
ts
, 
Ï‹¡_ts
) > 0) {

809 
maxack
 = 
¢
;

810 
Ï‹¡_ts
 = 
ts
;

815 ià(
	`ikı_ÿÆog
(
kı
, 
IKCP_LOG_IN_ACK
)) {

816 
	`ikı_log
(
kı
, 
IKCP_LOG_IN_ACK
,

817 "špuˆack: sn=%lu„‰=%ld„to=%ld", ()
¢
,

818 ()
	`_™imediff
(
kı
->
cu¼’t
, 
ts
),

819 ()
kı
->
rx_¹o
);

822 ià(
cmd
 =ğ
IKCP_CMD_PUSH
) {

823 ià(
	`ikı_ÿÆog
(
kı
, 
IKCP_LOG_IN_DATA
)) {

824 
	`ikı_log
(
kı
, 
IKCP_LOG_IN_DATA
,

825 "špuˆpsh: sn=%lus=%lu", ()
¢
, ()
ts
);

827 ià(
	`_™imediff
(
¢
, 
kı
->
rcv_nxt
 + kı->
rcv_wnd
) < 0) {

828 
	`ikı_ack_push
(
kı
, 
¢
, 
ts
);

829 ià(
	`_™imediff
(
¢
, 
kı
->
rcv_nxt
) >= 0) {

830 
£g
 = 
	`ikı_£gm’t_Ãw
(
kı
, 
Ën
);

831 
£g
->
cÚv
 = conv;

832 
£g
->
cmd
 = cmd;

833 
£g
->
äg
 = frg;

834 
£g
->
wnd
 = wnd;

835 
£g
->
ts
 =s;

836 
£g
->
¢
 = sn;

837 
£g
->
uÇ
 = una;

838 
£g
->
Ën
 =†en;

840 ià(
Ën
 > 0) {

841 
	`memıy
(
£g
->
d©a
, d©a, 
Ën
);

844 
	`ikı_·r£_d©a
(
kı
, 
£g
);

848 ià(
cmd
 =ğ
IKCP_CMD_WASK
) {

851 
kı
->
´obe
 |ğ
IKCP_ASK_TELL
;

852 ià(
	`ikı_ÿÆog
(
kı
, 
IKCP_LOG_IN_PROBE
)) {

853 
	`ikı_log
(
kı
, 
IKCP_LOG_IN_PROBE
, "input…robe");

856 ià(
cmd
 =ğ
IKCP_CMD_WINS
) {

858 ià(
	`ikı_ÿÆog
(
kı
, 
IKCP_LOG_IN_WINS
)) {

859 
	`ikı_log
(
kı
, 
IKCP_LOG_IN_WINS
,

860 "špuˆwšs: %lu", ()(
wnd
));

867 
d©a
 +ğ
Ën
;

868 
size
 -ğ
Ën
;

871 ià(
æag
 != 0) {

872 
	`ikı_·r£_ç¡ack
(
kı
, 
maxack
, 
Ï‹¡_ts
);

875 ià(
	`_™imediff
(
kı
->
¢d_uÇ
, 
´ev_uÇ
) > 0) {

876 ià(
kı
->
cwnd
 < kı->
rmt_wnd
) {

877 
IUINT32
 
mss
 = 
kı
->mss;

878 ià(
kı
->
cwnd
 < kı->
s¡h»sh
) {

879 
kı
->
cwnd
++;

880 
kı
->
šü
 +ğ
mss
;

882 ià(
kı
->
šü
 < 
mss
) kcp->incr = mss;

883 
kı
->
šü
 +ğ(
mss
 * mss) / kcp->incr + (mss / 16);

884 ià((
kı
->
cwnd
 + 1è* 
mss
 <ğkı->
šü
) {

886 
kı
->
cwnd
 = (kı->
šü
 + 
mss
 - 1) / ((mss > 0)? mss : 1);

888 
kı
->
cwnd
++;

892 ià(
kı
->
cwnd
 > kı->
rmt_wnd
) {

893 
kı
->
cwnd
 = kı->
rmt_wnd
;

894 
kı
->
šü
 = kı->
rmt_wnd
 * 
mss
;

900 
	}
}

906 *
	$ikı_’code_£g
(*
±r
, cÚ¡ 
IKCPSEG
 *
£g
)

908 
±r
 = 
	`ikı_’code32u
ÕŒ, 
£g
->
cÚv
);

909 
±r
 = 
	`ikı_’code8u
ÕŒ, (
IUINT8
)
£g
->
cmd
);

910 
±r
 = 
	`ikı_’code8u
ÕŒ, (
IUINT8
)
£g
->
äg
);

911 
±r
 = 
	`ikı_’code16u
ÕŒ, (
IUINT16
)
£g
->
wnd
);

912 
±r
 = 
	`ikı_’code32u
ÕŒ, 
£g
->
ts
);

913 
±r
 = 
	`ikı_’code32u
ÕŒ, 
£g
->
¢
);

914 
±r
 = 
	`ikı_’code32u
ÕŒ, 
£g
->
uÇ
);

915 
±r
 = 
	`ikı_’code32u
ÕŒ, 
£g
->
Ën
);

916  
±r
;

917 
	}
}

919 
	$ikı_wnd_unu£d
(cÚ¡ 
ikıcb
 *
kı
)

921 ià(
kı
->
Äcv_que
 < kı->
rcv_wnd
) {

922  
kı
->
rcv_wnd
 - kı->
Äcv_que
;

925 
	}
}

931 
	$ikı_æush
(
ikıcb
 *
kı
)

933 
IUINT32
 
cu¼’t
 = 
kı
->current;

934 *
bufãr
 = 
kı
->buffer;

935 *
±r
 = 
bufãr
;

936 
couÁ
, 
size
, 
i
;

937 
IUINT32
 
»£Á
, 
cwnd
;

938 
IUINT32
 
¹omš
;

939 
IQUEUEHEAD
 *
p
;

940 
chªge
 = 0;

941 
lo¡
 = 0;

942 
IKCPSEG
 
£g
;

945 ià(
kı
->
upd©ed
 == 0) ;

947 
£g
.
cÚv
 = 
kı
->conv;

948 
£g
.
cmd
 = 
IKCP_CMD_ACK
;

949 
£g
.
äg
 = 0;

950 
£g
.
wnd
 = 
	`ikı_wnd_unu£d
(
kı
);

951 
£g
.
uÇ
 = 
kı
->
rcv_nxt
;

952 
£g
.
Ën
 = 0;

953 
£g
.
¢
 = 0;

954 
£g
.
ts
 = 0;

957 
couÁ
 = 
kı
->
ackcouÁ
;

958 
i
 = 0; i < 
couÁ
; i++) {

959 
size
 = ()(
±r
 - 
bufãr
);

960 ià(
size
 + ()
IKCP_OVERHEAD
 > ()
kı
->
mtu
) {

961 
	`ikı_ouut
(
kı
, 
bufãr
, 
size
);

962 
±r
 = 
bufãr
;

964 
	`ikı_ack_g‘
(
kı
, 
i
, &
£g
.
¢
, &£g.
ts
);

965 
±r
 = 
	`ikı_’code_£g
ÕŒ, &
£g
);

968 
kı
->
ackcouÁ
 = 0;

971 ià(
kı
->
rmt_wnd
 == 0) {

972 ià(
kı
->
´obe_wa™
 == 0) {

973 
kı
->
´obe_wa™
 = 
IKCP_PROBE_INIT
;

974 
kı
->
ts_´obe
 = kı->
cu¼’t
 + kı->
´obe_wa™
;

977 ià(
	`_™imediff
(
kı
->
cu¼’t
, kı->
ts_´obe
) >= 0) {

978 ià(
kı
->
´obe_wa™
 < 
IKCP_PROBE_INIT
)

979 
kı
->
´obe_wa™
 = 
IKCP_PROBE_INIT
;

980 
kı
->
´obe_wa™
 += kcp->probe_wait / 2;

981 ià(
kı
->
´obe_wa™
 > 
IKCP_PROBE_LIMIT
)

982 
kı
->
´obe_wa™
 = 
IKCP_PROBE_LIMIT
;

983 
kı
->
ts_´obe
 = kı->
cu¼’t
 + kı->
´obe_wa™
;

984 
kı
->
´obe
 |ğ
IKCP_ASK_SEND
;

988 
kı
->
ts_´obe
 = 0;

989 
kı
->
´obe_wa™
 = 0;

993 ià(
kı
->
´obe
 & 
IKCP_ASK_SEND
) {

994 
£g
.
cmd
 = 
IKCP_CMD_WASK
;

995 
size
 = ()(
±r
 - 
bufãr
);

996 ià(
size
 + ()
IKCP_OVERHEAD
 > ()
kı
->
mtu
) {

997 
	`ikı_ouut
(
kı
, 
bufãr
, 
size
);

998 
±r
 = 
bufãr
;

1000 
±r
 = 
	`ikı_’code_£g
ÕŒ, &
£g
);

1004 ià(
kı
->
´obe
 & 
IKCP_ASK_TELL
) {

1005 
£g
.
cmd
 = 
IKCP_CMD_WINS
;

1006 
size
 = ()(
±r
 - 
bufãr
);

1007 ià(
size
 + ()
IKCP_OVERHEAD
 > ()
kı
->
mtu
) {

1008 
	`ikı_ouut
(
kı
, 
bufãr
, 
size
);

1009 
±r
 = 
bufãr
;

1011 
±r
 = 
	`ikı_’code_£g
ÕŒ, &
£g
);

1014 
kı
->
´obe
 = 0;

1017 
cwnd
 = 
	`_imš_
(
kı
->
¢d_wnd
, kı->
rmt_wnd
);

1018 ià(
kı
->
nocwnd
 =ğ0è
cwnd
 = 
	`_imš_
(kcp->cwnd, cwnd);

1021 
	`_™imediff
(
kı
->
¢d_nxt
, kı->
¢d_uÇ
 + 
cwnd
) < 0) {

1022 
IKCPSEG
 *
Ãw£g
;

1023 ià(
	`iqueue_is_em±y
(&
kı
->
¢d_queue
)) ;

1025 
Ãw£g
 = 
	`iqueue_’Œy
(
kı
->
¢d_queue
.
Ãxt
, 
IKCPSEG
, 
node
);

1027 
	`iqueue_d–
(&
Ãw£g
->
node
);

1028 
	`iqueue_add_
(&
Ãw£g
->
node
, &
kı
->
¢d_buf
);

1029 
kı
->
n¢d_que
--;

1030 
kı
->
n¢d_buf
++;

1032 
Ãw£g
->
cÚv
 = 
kı
->conv;

1033 
Ãw£g
->
cmd
 = 
IKCP_CMD_PUSH
;

1034 
Ãw£g
->
wnd
 = 
£g
.wnd;

1035 
Ãw£g
->
ts
 = 
cu¼’t
;

1036 
Ãw£g
->
¢
 = 
kı
->
¢d_nxt
++;

1037 
Ãw£g
->
uÇ
 = 
kı
->
rcv_nxt
;

1038 
Ãw£g
->
»£ndts
 = 
cu¼’t
;

1039 
Ãw£g
->
¹o
 = 
kı
->
rx_¹o
;

1040 
Ãw£g
->
ç¡ack
 = 0;

1041 
Ãw£g
->
xm™
 = 0;

1045 
»£Á
 = (
kı
->
ç¡»£nd
 > 0)? (
IUINT32
)kcp->fastresend : 0xffffffff;

1046 
¹omš
 = (
kı
->
nod–ay
 =ğ0)? (kı->
rx_¹o
 >> 3) : 0;

1049 
p
 = 
kı
->
¢d_buf
.
Ãxt
;… != &kcp->snd_buf;… =…->next) {

1050 
IKCPSEG
 *
£gm’t
 = 
	`iqueue_’Œy
(
p
, IKCPSEG, 
node
);

1051 
Ãed£nd
 = 0;

1052 ià(
£gm’t
->
xm™
 == 0) {

1053 
Ãed£nd
 = 1;

1054 
£gm’t
->
xm™
++;

1055 
£gm’t
->
¹o
 = 
kı
->
rx_¹o
;

1056 
£gm’t
->
»£ndts
 = 
cu¼’t
 + segm’t->
¹o
 + 
¹omš
;

1058 ià(
	`_™imediff
(
cu¼’t
, 
£gm’t
->
»£ndts
) >= 0) {

1059 
Ãed£nd
 = 1;

1060 
£gm’t
->
xm™
++;

1061 
kı
->
xm™
++;

1062 ià(
kı
->
nod–ay
 == 0) {

1063 
£gm’t
->
¹o
 +ğ
	`_imax_
(£gm’t->¹o, (
IUINT32
)
kı
->
rx_¹o
);

1065 
IINT32
 
¡•
 = (
kı
->
nod–ay
 < 2)?

1066 ((
IINT32
)(
£gm’t
->
¹o
)è: 
kı
->
rx_¹o
;

1067 
£gm’t
->
¹o
 +ğ
¡•
 / 2;

1069 
£gm’t
->
»£ndts
 = 
cu¼’t
 + segm’t->
¹o
;

1070 
lo¡
 = 1;

1072 ià(
£gm’t
->
ç¡ack
 >ğ
»£Á
) {

1073 ià(()
£gm’t
->
xm™
 <ğ
kı
->
ç¡lim™
 ||

1074 
kı
->
ç¡lim™
 <= 0) {

1075 
Ãed£nd
 = 1;

1076 
£gm’t
->
xm™
++;

1077 
£gm’t
->
ç¡ack
 = 0;

1078 
£gm’t
->
»£ndts
 = 
cu¼’t
 + segm’t->
¹o
;

1079 
chªge
++;

1083 ià(
Ãed£nd
) {

1084 
Ãed
;

1085 
£gm’t
->
ts
 = 
cu¼’t
;

1086 
£gm’t
->
wnd
 = 
£g
.wnd;

1087 
£gm’t
->
uÇ
 = 
kı
->
rcv_nxt
;

1089 
size
 = ()(
±r
 - 
bufãr
);

1090 
Ãed
 = 
IKCP_OVERHEAD
 + 
£gm’t
->
Ën
;

1092 ià(
size
 + 
Ãed
 > ()
kı
->
mtu
) {

1093 
	`ikı_ouut
(
kı
, 
bufãr
, 
size
);

1094 
±r
 = 
bufãr
;

1097 
±r
 = 
	`ikı_’code_£g
ÕŒ, 
£gm’t
);

1099 ià(
£gm’t
->
Ën
 > 0) {

1100 
	`memıy
(
±r
, 
£gm’t
->
d©a
, segm’t->
Ën
);

1101 
±r
 +ğ
£gm’t
->
Ën
;

1104 ià(
£gm’t
->
xm™
 >ğ
kı
->
d—d_lšk
) {

1105 
kı
->
¡©e
 = (
IUINT32
)-1;

1111 
size
 = ()(
±r
 - 
bufãr
);

1112 ià(
size
 > 0) {

1113 
	`ikı_ouut
(
kı
, 
bufãr
, 
size
);

1117 ià(
chªge
) {

1118 
IUINT32
 
šæight
 = 
kı
->
¢d_nxt
 - kı->
¢d_uÇ
;

1119 
kı
->
s¡h»sh
 = 
šæight
 / 2;

1120 ià(
kı
->
s¡h»sh
 < 
IKCP_THRESH_MIN
)

1121 
kı
->
s¡h»sh
 = 
IKCP_THRESH_MIN
;

1122 
kı
->
cwnd
 = kı->
s¡h»sh
 + 
»£Á
;

1123 
kı
->
šü
 = kı->
cwnd
 * kı->
mss
;

1126 ià(
lo¡
) {

1127 
kı
->
s¡h»sh
 = 
cwnd
 / 2;

1128 ià(
kı
->
s¡h»sh
 < 
IKCP_THRESH_MIN
)

1129 
kı
->
s¡h»sh
 = 
IKCP_THRESH_MIN
;

1130 
kı
->
cwnd
 = 1;

1131 
kı
->
šü
 = kı->
mss
;

1134 ià(
kı
->
cwnd
 < 1) {

1135 
kı
->
cwnd
 = 1;

1136 
kı
->
šü
 = kı->
mss
;

1138 
	}
}

1146 
	$ikı_upd©e
(
ikıcb
 *
kı
, 
IUINT32
 
cu¼’t
)

1148 
IINT32
 
¦­
;

1150 
kı
->
cu¼’t
 = current;

1152 ià(
kı
->
upd©ed
 == 0) {

1153 
kı
->
upd©ed
 = 1;

1154 
kı
->
ts_æush
 = kı->
cu¼’t
;

1157 
¦­
 = 
	`_™imediff
(
kı
->
cu¼’t
, kı->
ts_æush
);

1159 ià(
¦­
 >= 10000 || slap < -10000) {

1160 
kı
->
ts_æush
 = kı->
cu¼’t
;

1161 
¦­
 = 0;

1164 ià(
¦­
 >= 0) {

1165 
kı
->
ts_æush
 +ğkı->
š‹rv®
;

1166 ià(
	`_™imediff
(
kı
->
cu¼’t
, kı->
ts_æush
) >= 0) {

1167 
kı
->
ts_æush
 = kı->
cu¼’t
 + kı->
š‹rv®
;

1169 
	`ikı_æush
(
kı
);

1171 
	}
}

1183 
IUINT32
 
	$ikı_check
(cÚ¡ 
ikıcb
 *
kı
, 
IUINT32
 
cu¼’t
)

1185 
IUINT32
 
ts_æush
 = 
kı
->ts_flush;

1186 
IINT32
 
tm_æush
 = 0x7fffffff;

1187 
IINT32
 
tm_·ck‘
 = 0x7fffffff;

1188 
IUINT32
 
mšim®
 = 0;

1189 
IQUEUEHEAD
 *
p
;

1191 ià(
kı
->
upd©ed
 == 0) {

1192  
cu¼’t
;

1195 ià(
	`_™imediff
(
cu¼’t
, 
ts_æush
) >= 10000 ||

1196 
	`_™imediff
(
cu¼’t
, 
ts_æush
) < -10000) {

1197 
ts_æush
 = 
cu¼’t
;

1200 ià(
	`_™imediff
(
cu¼’t
, 
ts_æush
) >= 0) {

1201  
cu¼’t
;

1204 
tm_æush
 = 
	`_™imediff
(
ts_æush
, 
cu¼’t
);

1206 
p
 = 
kı
->
¢d_buf
.
Ãxt
;… != &kcp->snd_buf;… =…->next) {

1207 cÚ¡ 
IKCPSEG
 *
£g
 = 
	`iqueue_’Œy
(
p
, cÚ¡ IKCPSEG, 
node
);

1208 
IINT32
 
diff
 = 
	`_™imediff
(
£g
->
»£ndts
, 
cu¼’t
);

1209 ià(
diff
 <= 0) {

1210  
cu¼’t
;

1212 ià(
diff
 < 
tm_·ck‘
)m_packet = diff;

1215 
mšim®
 = (
IUINT32
)(
tm_·ck‘
 < 
tm_æush
 ?m_packet :m_flush);

1216 ià(
mšim®
 >ğ
kı
->
š‹rv®
) minimal = kcp->interval;

1218  
cu¼’t
 + 
mšim®
;

1219 
	}
}

1223 
	$ikı_£tmtu
(
ikıcb
 *
kı
, 
mtu
)

1225 *
bufãr
;

1226 ià(
mtu
 < 50 || mtu < ()
IKCP_OVERHEAD
)

1228 
bufãr
 = (*)
	`ikı_m®loc
((
mtu
 + 
IKCP_OVERHEAD
) * 3);

1229 ià(
bufãr
 =ğ
NULL
)

1231 
kı
->
mtu
 = mtu;

1232 
kı
->
mss
 = kı->
mtu
 - 
IKCP_OVERHEAD
;

1233 
	`ikı_ä“
(
kı
->
bufãr
);

1234 
kı
->
bufãr
 = buffer;

1236 
	}
}

1238 
	$ikı_š‹rv®
(
ikıcb
 *
kı
, 
š‹rv®
)

1240 ià(
š‹rv®
 > 5000) interval = 5000;

1241 ià(
š‹rv®
 < 10) interval = 10;

1242 
kı
->
š‹rv®
 = interval;

1244 
	}
}

1246 
	$ikı_nod–ay
(
ikıcb
 *
kı
, 
nod–ay
, 
š‹rv®
, 
»£nd
, 
nc
)

1248 ià(
nod–ay
 >= 0) {

1249 
kı
->
nod–ay
 =‚odelay;

1250 ià(
nod–ay
) {

1251 
kı
->
rx_mš¹o
 = 
IKCP_RTO_NDL
;

1254 
kı
->
rx_mš¹o
 = 
IKCP_RTO_MIN
;

1257 ià(
š‹rv®
 >= 0) {

1258 ià(
š‹rv®
 > 5000) interval = 5000;

1259 ià(
š‹rv®
 < 10) interval = 10;

1260 
kı
->
š‹rv®
 = interval;

1262 ià(
»£nd
 >= 0) {

1263 
kı
->
ç¡»£nd
 = 
»£nd
;

1265 ià(
nc
 >= 0) {

1266 
kı
->
nocwnd
 = 
nc
;

1269 
	}
}

1272 
	$ikı_wndsize
(
ikıcb
 *
kı
, 
¢dwnd
, 
rcvwnd
)

1274 ià(
kı
) {

1275 ià(
¢dwnd
 > 0) {

1276 
kı
->
¢d_wnd
 = 
¢dwnd
;

1278 ià(
rcvwnd
 > 0) {

1279 
kı
->
rcv_wnd
 = 
	`_imax_
(
rcvwnd
, 
IKCP_WND_RCV
);

1283 
	}
}

1285 
	$ikı_wa™¢d
(cÚ¡ 
ikıcb
 *
kı
)

1287  
kı
->
n¢d_buf
 + kı->
n¢d_que
;

1288 
	}
}

1292 
IUINT32
 
	$ikı_g‘cÚv
(cÚ¡ *
±r
)

1294 
IUINT32
 
cÚv
;

1295 
	`ikı_decode32u
((cÚ¡ *)
±r
, &
cÚv
);

1296  
cÚv
;

1297 
	}
}

	@ikcp.h

12 #iâdeà
__IKCP_H__


13 
	#__IKCP_H__


	)

15 
	~<¡ddef.h
>

16 
	~<¡dlib.h
>

17 
	~<as£¹.h
>

23 #iâdeà
__INTEGER_32_BITS__


24 
	#__INTEGER_32_BITS__


	)

25 #ià
defšed
(
_WIN64
è|| defšed(
WIN64
è|| defšed(
__amd64__
) || \

26 
defšed
(
__x86_64
è|| defšed(
__x86_64__
è|| defšed(
_M_IA64
) || \

27 
	$defšed
(
_M_AMD64
)

28 
	tISTDUINT32
;

29 
	tISTDINT32
;

30 #–ià
	`defšed
(
_WIN32
è|| defšed(
WIN32
è|| defšed(
__i386__
) || \

31 
	`defšed
(
__i386
è|| 
	$defšed
(
_M_X86
)

32 
	tISTDUINT32
;

33 
	tISTDINT32
;

34 #–ià
	`defšed
(
__MACOS__
)

35 
UIÁ32
 
	tISTDUINT32
;

36 
SIÁ32
 
	tISTDINT32
;

37 #–ià
	`defšed
(
__APPLE__
è&& defšed(
__MACH__
)

38 
	~<sys/ty³s.h
>

39 
u_št32_t
 
	tISTDUINT32
;

40 
št32_t
 
	tISTDINT32
;

41 #–ià
	`defšed
(
__BEOS__
)

42 
	~<sys/š‰y³s.h
>

43 
u_št32_t
 
	tISTDUINT32
;

44 
št32_t
 
	tISTDINT32
;

45 #–ià(
	`defšed
(
_MSC_VER
è|| defšed(
__BORLANDC__
)è&& (!defšed(
__MSDOS__
))

46 
	t__št32
 
	tISTDUINT32
;

47 
__št32
 
	tISTDINT32
;

48 #–ià
	`defšed
(
__GNUC__
)

49 
	~<¡dšt.h
>

50 
ušt32_t
 
	tISTDUINT32
;

51 
št32_t
 
	tISTDINT32
;

53 
	tISTDUINT32
;

54 
	tISTDINT32
;

62 #iâdeà
__IINT8_DEFINED


63 
	#__IINT8_DEFINED


	)

64 
	tIINT8
;

67 #iâdeà
__IUINT8_DEFINED


68 
	#__IUINT8_DEFINED


	)

69 
	tIUINT8
;

72 #iâdeà
__IUINT16_DEFINED


73 
	#__IUINT16_DEFINED


	)

74 
	tIUINT16
;

77 #iâdeà
__IINT16_DEFINED


78 
	#__IINT16_DEFINED


	)

79 
	tIINT16
;

82 #iâdeà
__IINT32_DEFINED


83 
	#__IINT32_DEFINED


	)

84 
ISTDINT32
 
	tIINT32
;

87 #iâdeà
__IUINT32_DEFINED


88 
	#__IUINT32_DEFINED


	)

89 
ISTDUINT32
 
	tIUINT32
;

92 #iâdeà
__IINT64_DEFINED


93 
	#__IINT64_DEFINED


	)

94 #ià
	`defšed
(
_MSC_VER
è|| defšed(
__BORLANDC__
)

95 
__št64
 
	tIINT64
;

97 
	tIINT64
;

101 #iâdeà
__IUINT64_DEFINED


102 
	#__IUINT64_DEFINED


	)

103 #ià
	`defšed
(
_MSC_VER
è|| defšed(
__BORLANDC__
)

104 
	t__št64
 
	tIUINT64
;

106 
	tIUINT64
;

110 #iâdeà
INLINE


111 #ià
	`defšed
(
__GNUC__
)

113 #ià(
__GNUC__
 > 3è|| ((__GNUC__ =ğ3è&& (
__GNUC_MINOR__
 >= 1))

114 
	#INLINE
 
__šlše__
 
	`__©Œibu‹__
((
®ways_šlše
))

	)

116 
	#INLINE
 
__šlše__


	)

119 #–ià(
	`defšed
(
_MSC_VER
è|| defšed(
__BORLANDC__
è|| defšed(
__WATCOMC__
))

120 
	#INLINE
 
__šlše


	)

122 
	#INLINE


	)

126 #ià(!
	`defšed
(
__ılu¥lus
)è&& (!defšed(
šlše
))

127 
	#šlše
 
INLINE


	)

134 #iâdeà
__IQUEUE_DEF__


135 
	#__IQUEUE_DEF__


	)

137 
	sIQUEUEHEAD
 {

138 
IQUEUEHEAD
 *
Ãxt
, *
´ev
;

141 
IQUEUEHEAD
 
	tiqueue_h—d
;

147 
	#IQUEUE_HEAD_INIT
(
Çme
è{ &Òame), &Òameè
	}

	)
}

148 
	#IQUEUE_HEAD
(
Çme
è\

	)

149 
IQUEUEHEAD
 
	gÇme
 = 
	$IQUEUE_HEAD_INIT
(
Çme
)

151 
	#IQUEUE_INIT
(
±r
èĞ\

	)

152 (
±r
)->
Ãxt
 = (±r), (±r)->
´ev
 = (ptr))

154 
	#IOFFSETOF
(
TYPE
, 
MEMBER
è((
size_t
è&((TYPE *)0)->MEMBER)

	)

156 
	#ICONTAINEROF
(
±r
, 
ty³
, 
memb”
èĞ\

	)

157 (
ty³
*)Ğ((*)(Ñy³*)
±r
)è- 
	$IOFFSETOF
(
ty³
, 
memb”
)) )

159 
	#IQUEUE_ENTRY
(
±r
, 
ty³
, 
memb”
è
	`ICONTAINEROF
ÕŒ,y³, memb”)

	)

165 
	#IQUEUE_ADD
(
node
, 
h—d
èĞ\

	)

166 (
node
)->
´ev
 = (
h—d
), (node)->
Ãxt
 = (head)->next, \

167 (
h—d
)->
Ãxt
->
´ev
 = (
node
), (head)->next = (node))

169 
	#IQUEUE_ADD_TAIL
(
node
, 
h—d
èĞ\

	)

170 (
node
)->
´ev
 = (
h—d
)->´ev, (node)->
Ãxt
 = (head), \

171 (
h—d
)->
´ev
->
Ãxt
 = (
node
), (head)->prev = (node))

173 
	#IQUEUE_DEL_BETWEEN
(
p
, 
n
è(Ò)->
´ev
 = (p), (p)->
Ãxt
 = (n))

	)

175 
	#IQUEUE_DEL
(
’Œy
è(\

	)

176 (
’Œy
)->
Ãxt
->
´ev
 = (entry)->prev, \

177 (
’Œy
)->
´ev
->
Ãxt
 = (entry)->next, \

178 (
’Œy
)->
Ãxt
 = 0, (’Œy)->
´ev
 = 0)

180 
	#IQUEUE_DEL_INIT
(
’Œy
èdØ{ \

	)

181 
	`IQUEUE_DEL
(
’Œy
); 
	`IQUEUE_INIT
ÓÁry); 
	}
} 0)

183 
	#IQUEUE_IS_EMPTY
(
’Œy
è(ÓÁryè=ğÓÁry)->
Ãxt
)

	)

185 
	#iqueue_š™
 
IQUEUE_INIT


	)

186 
	#iqueue_’Œy
 
IQUEUE_ENTRY


	)

187 
	#iqueue_add
 
IQUEUE_ADD


	)

188 
	#iqueue_add_
 
IQUEUE_ADD_TAIL


	)

189 
	#iqueue_d–
 
IQUEUE_DEL


	)

190 
	#iqueue_d–_š™
 
IQUEUE_DEL_INIT


	)

191 
	#iqueue_is_em±y
 
IQUEUE_IS_EMPTY


	)

193 
	#IQUEUE_FOREACH
(
™”©Ü
, 
h—d
, 
TYPE
, 
MEMBER
è\

	)

194 (
™”©Ü
èğ
	`iqueue_’Œy
((
h—d
)->
Ãxt
, 
TYPE
, 
MEMBER
); \

195 &((
™”©Ü
)->
MEMBER
è!ğ(
h—d
); \

196 (
™”©Ü
èğ
	`iqueue_’Œy
((™”©Ü)->
MEMBER
.
Ãxt
, 
TYPE
, MEMBER))

198 
	#iqueue_fÜ—ch
(
™”©Ü
, 
h—d
, 
TYPE
, 
MEMBER
è\

	)

199 
	$IQUEUE_FOREACH
(
™”©Ü
, 
h—d
, 
TYPE
, 
MEMBER
)

201 
	#iqueue_fÜ—ch_’Œy
(
pos
, 
h—d
è\

	)

202  (
pos
èğ(
h—d
)->
Ãxt
; (pos) != (head) ; (pos) = (pos)->next )

205 
	#__iqueue_¥liû
(
li¡
, 
h—d
èdØ{ \

	)

206 
iqueue_h—d
 *
fœ¡
 = (
li¡
)->
Ãxt
, *
Ï¡
 = (li¡)->
´ev
; \

207 
iqueue_h—d
 *
©
 = (
h—d
)->
Ãxt
; \

208 (
fœ¡
)->
´ev
 = (
h—d
), (h—d)->
Ãxt
 = (first); \

209 (
Ï¡
)->
Ãxt
 = (
©
), (©)->
´ev
 = (Ï¡); 
	}
} 0)

211 
	#iqueue_¥liû
(
li¡
, 
h—d
èdØ{ \

	)

212 ià(!
	`iqueue_is_em±y
(
li¡
)è
	`__iqueue_¥liû
Öi¡, 
h—d
); 
	}
} 0)

214 
	#iqueue_¥liû_š™
(
li¡
, 
h—d
èdØ{ \

	)

215 
	`iqueue_¥liû
(
li¡
, 
h—d
); 
	`iqueue_š™
Öi¡); 
	}
} 0)

218 #ifdeà
_MSC_VER


219 #´agm¨
	`w¬nšg
(
di§bË
:4311)

220 #´agm¨
	`w¬nšg
(
di§bË
:4312)

221 #´agm¨
	`w¬nšg
(
di§bË
:4996)

230 #iâdeà
IWORDS_BIG_ENDIAN


231 #ifdeà
_BIG_ENDIAN_


232 #ià
_BIG_ENDIAN_


233 
	#IWORDS_BIG_ENDIAN
 1

	)

236 #iâdeà
IWORDS_BIG_ENDIAN


237 #ià
	`defšed
(
__hµa__
) || \

238 
	`defšed
(
__m68k__
è|| defšed(
mc68000
è|| defšed(
_M_M68K
) || \

239 (
	`defšed
(
__MIPS__
è&& defšed(
__MIPSEB__
)) || \

240 
	`defšed
(
__µc__
è|| defšed(
__POWERPC__
è|| defšed(
_M_PPC
) || \

241 
	`defšed
(
__¥¬c__
è|| defšed(
__pow”pc__
) || \

242 
	`defšed
(
__mc68000__
è|| defšed(
__s390x__
è|| 
	$defšed
(
__s390__
)

243 
	#IWORDS_BIG_ENDIAN
 1

	)

246 #iâdeà
IWORDS_BIG_ENDIAN


247 
	#IWORDS_BIG_ENDIAN
 0

	)

251 #iâdeà
IWORDS_MUST_ALIGN


252 #ià
	`defšed
(
__i386__
è|| defšed(
__i386
è|| defšed(
_i386_
)

253 
	#IWORDS_MUST_ALIGN
 0

	)

254 #–ià
	`defšed
(
_M_IX86
è|| defšed(
_X86_
è|| defšed(
__x86_64__
)

255 
	#IWORDS_MUST_ALIGN
 0

	)

256 #–ià
	`defšed
(
__amd64
è|| defšed(
__amd64__
)

257 
	#IWORDS_MUST_ALIGN
 0

	)

259 
	#IWORDS_MUST_ALIGN
 1

	)

267 
	sIKCPSEG


269 
IQUEUEHEAD
 
node
;

270 
IUINT32
 
cÚv
;

271 
IUINT32
 
cmd
;

272 
IUINT32
 
äg
;

273 
IUINT32
 
wnd
;

274 
IUINT32
 
ts
;

275 
IUINT32
 
¢
;

276 
IUINT32
 
uÇ
;

277 
IUINT32
 
Ën
;

278 
IUINT32
 
»£ndts
;

279 
IUINT32
 
¹o
;

280 
IUINT32
 
ç¡ack
;

281 
IUINT32
 
xm™
;

282 
d©a
[1];

289 
	sIKCPCB


291 
IUINT32
 
cÚv
, 
mtu
, 
mss
, 
¡©e
;

292 
IUINT32
 
¢d_uÇ
, 
¢d_nxt
, 
rcv_nxt
;

293 
IUINT32
 
ts_»ûÁ
, 
ts_Ï¡ack
, 
s¡h»sh
;

294 
IINT32
 
rx_¹tv®
, 
rx_¤‰
, 
rx_¹o
, 
rx_mš¹o
;

295 
IUINT32
 
¢d_wnd
, 
rcv_wnd
, 
rmt_wnd
, 
cwnd
, 
´obe
;

296 
IUINT32
 
cu¼’t
, 
š‹rv®
, 
ts_æush
, 
xm™
;

297 
IUINT32
 
Äcv_buf
, 
n¢d_buf
;

298 
IUINT32
 
Äcv_que
, 
n¢d_que
;

299 
IUINT32
 
nod–ay
, 
upd©ed
;

300 
IUINT32
 
ts_´obe
, 
´obe_wa™
;

301 
IUINT32
 
d—d_lšk
, 
šü
;

302 
IQUEUEHEAD
 
¢d_queue
;

303 
IQUEUEHEAD
 
rcv_queue
;

304 
IQUEUEHEAD
 
¢d_buf
;

305 
IQUEUEHEAD
 
rcv_buf
;

306 
IUINT32
 *
ackli¡
;

307 
IUINT32
 
ackcouÁ
;

308 
IUINT32
 
ackblock
;

309 *
u£r
;

310 *
bufãr
;

311 
ç¡»£nd
;

312 
ç¡lim™
;

313 
nocwnd
, 
¡»am
;

314 
logmask
;

315 (*
ouut
)(cÚ¡ *
buf
, 
Ën
, 
IKCPCB
 *
kı
, *
u£r
);

316 (*
wr™–og
)(cÚ¡ *
log
, 
IKCPCB
 *
kı
, *
u£r
);

320 
IKCPCB
 
	tikıcb
;

322 
	#IKCP_LOG_OUTPUT
 1

	)

323 
	#IKCP_LOG_INPUT
 2

	)

324 
	#IKCP_LOG_SEND
 4

	)

325 
	#IKCP_LOG_RECV
 8

	)

326 
	#IKCP_LOG_IN_DATA
 16

	)

327 
	#IKCP_LOG_IN_ACK
 32

	)

328 
	#IKCP_LOG_IN_PROBE
 64

	)

329 
	#IKCP_LOG_IN_WINS
 128

	)

330 
	#IKCP_LOG_OUT_DATA
 256

	)

331 
	#IKCP_LOG_OUT_ACK
 512

	)

332 
	#IKCP_LOG_OUT_PROBE
 1024

	)

333 
	#IKCP_LOG_OUT_WINS
 2048

	)

335 #ifdeà
__ılu¥lus


346 
ikıcb
* 
	`ikı_ü—‹
(
IUINT32
 
cÚv
, *
u£r
);

349 
	`ikı_»Ëa£
(
ikıcb
 *
kı
);

352 
	`ikı_£touut
(
ikıcb
 *
kı
, (*
ouut
)(cÚ¡ *
buf
, 
Ën
,

353 
ikıcb
 *
kı
, *
u£r
));

356 
	`ikı_»cv
(
ikıcb
 *
kı
, *
bufãr
, 
Ën
);

359 
	`ikı_£nd
(
ikıcb
 *
kı
, cÚ¡ *
bufãr
, 
Ën
);

364 
	`ikı_upd©e
(
ikıcb
 *
kı
, 
IUINT32
 
cu¼’t
);

373 
IUINT32
 
	`ikı_check
(cÚ¡ 
ikıcb
 *
kı
, IUINT32 
cu¼’t
);

376 
	`ikı_šput
(
ikıcb
 *
kı
, cÚ¡ *
d©a
, 
size
);

379 
	`ikı_æush
(
ikıcb
 *
kı
);

382 
	`ikı_³eksize
(cÚ¡ 
ikıcb
 *
kı
);

385 
	`ikı_£tmtu
(
ikıcb
 *
kı
, 
mtu
);

388 
	`ikı_wndsize
(
ikıcb
 *
kı
, 
¢dwnd
, 
rcvwnd
);

391 
	`ikı_wa™¢d
(cÚ¡ 
ikıcb
 *
kı
);

398 
	`ikı_nod–ay
(
ikıcb
 *
kı
, 
nod–ay
, 
š‹rv®
, 
»£nd
, 
nc
);

401 
	`ikı_log
(
ikıcb
 *
kı
, 
mask
, cÚ¡ *
fmt
, ...);

404 
	`ikı_®loÿtÜ
(* (*
Ãw_m®loc
)(
size_t
), (*
Ãw_ä“
)(*));

407 
IUINT32
 
	`ikı_g‘cÚv
(cÚ¡ *
±r
);

410 #ifdeà
__ılu¥lus


411 
	}
}

	@test.cpp

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

13 
	~"‹¡.h
"

14 
	~"ikı.c
"

18 
L©’cySimuÏtÜ
 *
	gvÃt
;

21 
	$udp_ouut
(cÚ¡ *
buf
, 
Ën
, 
ikıcb
 *
kı
, *
u£r
)

23 uniÚ { 
id
; *
±r
; } 
·¿m‘”
;

24 
·¿m‘”
.
±r
 = 
u£r
;

25 
vÃt
->
	`£nd
(
·¿m‘”
.
id
, 
buf
, 
Ën
);

27 
	}
}

30 
	$‹¡
(
mode
)

33 
vÃt
 = 
Ãw
 
	`L©’cySimuÏtÜ
(10, 60, 125);

37 
ikıcb
 *
kı1
 = 
	`ikı_ü—‹
(0x11223344, (*)0);

38 
ikıcb
 *
kı2
 = 
	`ikı_ü—‹
(0x11223344, (*)1);

41 
kı1
->
ouut
 = 
udp_ouut
;

42 
kı2
->
ouut
 = 
udp_ouut
;

44 
IUINT32
 
cu¼’t
 = 
	`işock
();

45 
IUINT32
 
¦­
 = 
cu¼’t
 + 20;

46 
IUINT32
 
šdex
 = 0;

47 
IUINT32
 
Ãxt
 = 0;

48 
IINT64
 
sum¹t
 = 0;

49 
couÁ
 = 0;

50 
max¹t
 = 0;

54 
	`ikı_wndsize
(
kı1
, 128, 128);

55 
	`ikı_wndsize
(
kı2
, 128, 128);

58 ià(
mode
 == 0) {

60 
	`ikı_nod–ay
(
kı1
, 0, 10, 0, 0);

61 
	`ikı_nod–ay
(
kı2
, 0, 10, 0, 0);

63 ià(
mode
 == 1) {

65 
	`ikı_nod–ay
(
kı1
, 0, 10, 0, 1);

66 
	`ikı_nod–ay
(
kı2
, 0, 10, 0, 1);

73 
	`ikı_nod–ay
(
kı1
, 2, 10, 2, 1);

74 
	`ikı_nod–ay
(
kı2
, 2, 10, 2, 1);

75 
kı1
->
rx_mš¹o
 = 10;

76 
kı1
->
ç¡»£nd
 = 1;

80 
bufãr
[2000];

81 
hr
;

83 
IUINT32
 
ts1
 = 
	`işock
();

86 
	`i¦“p
(1);

87 
cu¼’t
 = 
	`işock
();

88 
	`ikı_upd©e
(
kı1
, 
	`işock
());

89 
	`ikı_upd©e
(
kı2
, 
	`işock
());

92 ; 
cu¼’t
 >ğ
¦­
; slap += 20) {

93 ((
IUINT32
*)
bufãr
)[0] = 
šdex
++;

94 ((
IUINT32
*)
bufãr
)[1] = 
cu¼’t
;

97 
	`ikı_£nd
(
kı1
, 
bufãr
, 8);

102 
hr
 = 
vÃt
->
	`»cv
(1, 
bufãr
, 2000);

103 ià(
hr
 < 0) ;

105 
	`ikı_šput
(
kı2
, 
bufãr
, 
hr
);

110 
hr
 = 
vÃt
->
	`»cv
(0, 
bufãr
, 2000);

111 ià(
hr
 < 0) ;

113 
	`ikı_šput
(
kı1
, 
bufãr
, 
hr
);

118 
hr
 = 
	`ikı_»cv
(
kı2
, 
bufãr
, 10);

120 ià(
hr
 < 0) ;

122 
	`ikı_£nd
(
kı2
, 
bufãr
, 
hr
);

127 
hr
 = 
	`ikı_»cv
(
kı1
, 
bufãr
, 10);

129 ià(
hr
 < 0) ;

130 
IUINT32
 
¢
 = *(IUINT32*)(
bufãr
 + 0);

131 
IUINT32
 
ts
 = *(IUINT32*)(
bufãr
 + 4);

132 
IUINT32
 
¹t
 = 
cu¼’t
 - 
ts
;

134 ià(
¢
 !ğ
Ãxt
) {

136 
	`´štf
("ERROR sÀ%d<->%d\n", ()
couÁ
, ()
Ãxt
);

140 
Ãxt
++;

141 
sum¹t
 +ğ
¹t
;

142 
couÁ
++;

143 ià(
¹t
 > (
IUINT32
)
max¹t
) maxrtt =„tt;

145 
	`´štf
("[RECV] mode=%d sn=%d„‰=%d\n", 
mode
, ()
¢
, ()
¹t
);

147 ià(
Ãxt
 > 1000) ;

150 
ts1
 = 
	`işock
() -s1;

152 
	`ikı_»Ëa£
(
kı1
);

153 
	`ikı_»Ëa£
(
kı2
);

155 cÚ¡ *
Çmes
[3] = { "default", "normal", "fast" };

156 
	`´štf
("% mod»suÉ (%dms):\n", 
Çmes
[
mode
], ()
ts1
);

157 
	`´štf
("avg¹t=%d max¹t=%dx=%d\n", ()(
sum¹t
 / 
couÁ
), ()
max¹t
, ()
vÃt
->
tx1
);

158 
	`´štf
("pressƒntero‚ext ...\n");

159 
ch
; 
	`sÿnf
("%c", &ch);

160 
	}
}

162 
	$maš
()

164 
	`‹¡
(0);

165 
	`‹¡
(1);

166 
	`‹¡
(2);

168 
	}
}

	@test.h

1 #iâdeà
__TEST_H__


2 
	#__TEST_H__


	)

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<time.h
>

7 
	~<ùy³.h
>

8 
	~<¡ršg.h
>

10 
	~"ikı.h
"

12 #ià
defšed
(
WIN32
è|| defšed(
_WIN32
è|| defšed(
WIN64
è|| defšed(
_WIN64
)

13 
	~<wšdows.h
>

14 #–ià!
defšed
(
__unix
)

15 
	#__unix


	)

18 #ifdeà
__unix


19 
	~<uni¡d.h
>

20 
	~<sys/time.h
>

21 
	~<sys/wa™.h
>

22 
	~<sys/ty³s.h
>

26 
šlše
 
	$™imeofday
(*
£c
, *
u£c
)

28 #ià
	`defšed
(
__unix
)

29 
timev®
 
time
;

30 
	`g‘timeofday
(&
time
, 
NULL
);

31 ià(
£c
è*£øğ
time
.
tv_£c
;

32 ià(
u£c
è*u£øğ
time
.
tv_u£c
;

34 
mode
 = 0, 
add£c
 = 0;

35 
BOOL
 
»tv®
;

36 
IINT64
 
äeq
 = 1;

37 
IINT64
 
qpc
;

38 ià(
mode
 == 0) {

39 
»tv®
 = 
	`Qu”yP”fÜmªûF»qu’cy
((
LARGE_INTEGER
*)&
äeq
);

40 
äeq
 = (freq == 0)? 1 : freq;

41 
»tv®
 = 
	`Qu”yP”fÜmªûCouÁ”
((
LARGE_INTEGER
*)&
qpc
);

42 
add£c
 = ()
	`time
(
NULL
);

43 
add£c
 =‡dd£ø- ()((
qpc
 / 
äeq
) & 0x7fffffff);

44 
mode
 = 1;

46 
»tv®
 = 
	`Qu”yP”fÜmªûCouÁ”
((
LARGE_INTEGER
*)&
qpc
);

47 
»tv®
 =„etval * 2;

48 ià(
£c
è*£øğ()(
qpc
 / 
äeq
è+ 
add£c
;

49 ià(
u£c
è*u£øğ()((
qpc
 % 
äeq
) * 1000000 / freq);

51 
	}
}

54 
šlše
 
IINT64
 
	$işock64
()

56 
s
, 
u
;

57 
IINT64
 
v®ue
;

58 
	`™imeofday
(&
s
, &
u
);

59 
v®ue
 = ((
IINT64
)
s
è* 1000 + (
u
 / 1000);

60  
v®ue
;

61 
	}
}

63 
šlše
 
IUINT32
 
	$işock
()

65  (
IUINT32
)(
	`işock64
() & 0xfffffffful);

66 
	}
}

69 
šlše
 
	$i¦“p
(
mli£cÚd
)

71 #ifdeà
__unix


72 
time¥ec
 
ts
;

73 
ts
.
tv_£c
 = (
time_t
)(
mli£cÚd
 / 1000);

74 
ts
.
tv_n£c
 = ()((
mli£cÚd
 % 1000) * 1000000);

76 
	`u¦“p
((
mli£cÚd
 << 10) - (millisecond << 4) - (millisecond << 3));

77 #–ià
	`defšed
(
_WIN32
)

78 
	`SË•
(
mli£cÚd
);

80 
	}
}

82 #ifdeà
__ılu¥lus


83 
	~<li¡
>

84 
	~<veùÜ
>

87 şas 
	cD–ayPack‘


89 
	mpublic
:

90 
vœtu®
 ~
	$D–ayPack‘
() {

91 ià(
_±r
è
d–‘e
[] _ptr;

92 
_±r
 = 
NULL
;

95 
	$D–ayPack‘
(
size
, cÚ¡ *
¤c
 = 
NULL
) {

96 
_±r
 = 
Ãw
 [
size
];

97 
_size
 = 
size
;

98 ià(
¤c
) {

99 
	`memıy
(
_±r
, 
¤c
, 
size
);

101 
	}
}

103 * 
	$±r
(è{  
_±r
; 
	}
}

104 cÚ¡ * 
	$±r
(ècÚ¡ {  
_±r
; 
	}
}

106 
	$size
(ècÚ¡ {  
_size
; 
	}
}

107 
IUINT32
 
	$ts
(ècÚ¡ {  
_ts
; 
	}
}

108 
	$£‰s
(
IUINT32
 
ts
è{ 
_ts
 =s; 
	}
}

110 
	g´Ùeùed
:

111 *
_±r
;

112 
	g_size
;

113 
IUINT32
 
	g_ts
;

117 şas 
	cRªdom


119 
	mpublic
:

120 
	$Rªdom
(
size
) {

121 
this
->
size
 = 0;

122 
£eds
.
	`»size
(
size
);

125 
	$¿ndom
() {

126 
x
, 
i
;

127 ià(
£eds
.
	`size
() == 0)  0;

128 ià(
size
 == 0) {

129 
i
 = 0; i < ()
£eds
.
	`size
(); i++) {

130 
£eds
[
i
] = i;

132 
size
 = ()
£eds
.
	`size
();

134 
i
 = 
	`¿nd
(è% 
size
;

135 
x
 = 
£eds
[
i
];

136 
£eds
[
i
] = s“ds[--
size
];

137  
x
;

138 
	}
}

140 
	g´Ùeùed
:

141 
size
;

142 
	g¡d
::
veùÜ
<> 
£eds
;

146 şas 
	cL©’cySimuÏtÜ


148 
	mpublic
:

150 
vœtu®
 ~
	$L©’cySimuÏtÜ
() {

151 
	`ş—r
();

157 
	$L©’cySimuÏtÜ
(
lo¡¿‹
 = 10, 
¹tmš
 = 60, 
¹tmax
 = 125, 
nmax
 = 1000):

158 
	`r12
(100), 
	$r21
(100) {

159 
cu¼’t
 = 
	`işock
();

160 
this
->
lo¡¿‹
 =†ostrate / 2;

161 
this
->
¹tmš
 =„ttmin / 2;

162 
this
->
¹tmax
 =„ttmax / 2;

163 
this
->
nmax
 =‚max;

164 
tx1
 = 
tx2
 = 0;

165 
	}
}

168 
	$ş—r
() {

169 
D–ayTuÂ–
::
™”©Ü
 
™
;

170 
™
 = 
p12
.
	`begš
(); iˆ!ğp12.
	`’d
(); it++) {

171 
d–‘e
 *
™
;

173 
™
 = 
p21
.
	`begš
(); iˆ!ğp21.
	`’d
(); it++) {

174 
d–‘e
 *
™
;

176 
p12
.
	`ş—r
();

177 
p21
.
	`ş—r
();

178 
	}
}

182 
	$£nd
(
³”
, cÚ¡ *
d©a
, 
size
) {

183 ià(
³”
 == 0) {

184 
tx1
++;

185 ià(
r12
.
	`¿ndom
(è< 
lo¡¿‹
) ;

186 ià(()
p12
.
	`size
(è>ğ
nmax
) ;

188 
tx2
++;

189 ià(
r21
.
	`¿ndom
(è< 
lo¡¿‹
) ;

190 ià(()
p21
.
	`size
(è>ğ
nmax
) ;

192 
D–ayPack‘
 *
pkt
 = 
Ãw
 
	`D–ayPack‘
(
size
, 
d©a
);

193 
cu¼’t
 = 
	`işock
();

194 
IUINT32
 
d–ay
 = 
¹tmš
;

195 ià(
¹tmax
 > 
¹tmš
è
d–ay
 +ğ
	`¿nd
() % (rttmax -„ttmin);

196 
pkt
->
	`£‰s
(
cu¼’t
 + 
d–ay
);

197 ià(
³”
 == 0) {

198 
p12
.
	`push_back
(
pkt
);

200 
p21
.
	`push_back
(
pkt
);

202 
	}
}

205 
	$»cv
(
³”
, *
d©a
, 
maxsize
) {

206 
D–ayTuÂ–
::
™”©Ü
 
™
;

207 ià(
³”
 == 0) {

208 
™
 = 
p21
.
	`begš
();

209 ià(
p21
.
	`size
() == 0)  -1;

211 
™
 = 
p12
.
	`begš
();

212 ià(
p12
.
	`size
() == 0)  -1;

214 
D–ayPack‘
 *
pkt
 = *
™
;

215 
cu¼’t
 = 
	`işock
();

216 ià(
cu¼’t
 < 
pkt
->
	`ts
())  -2;

217 ià(
maxsize
 < 
pkt
->
	`size
())  -3;

218 ià(
³”
 == 0) {

219 
p21
.
	`”a£
(
™
);

221 
p12
.
	`”a£
(
™
);

223 
maxsize
 = 
pkt
->
	`size
();

224 
	`memıy
(
d©a
, 
pkt
->
	`±r
(), 
maxsize
);

225 
d–‘e
 
pkt
;

226  
maxsize
;

227 
	}
}

229 
	gpublic
:

230 
tx1
;

231 
	gtx2
;

233 
	g´Ùeùed
:

234 
IUINT32
 
cu¼’t
;

235 
	glo¡¿‹
;

236 
	g¹tmš
;

237 
	g¹tmax
;

238 
	gnmax
;

239 
	g¡d
::
	tli¡
<
	tD–ayPack‘
*> 
	tD–ayTuÂ–
;

240 
D–ayTuÂ–
 
	gp12
;

241 
D–ayTuÂ–
 
	gp21
;

242 
Rªdom
 
	gr12
;

243 
Rªdom
 
	gr21
;

	@
1
.
0
4
30
ikcp.c
ikcp.h
test.cpp
test.h
